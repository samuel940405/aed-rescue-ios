workflows:
  ios-release:
    name: iOS Release
    max_build_duration: 60
    instance_type: mac_mini_m2
    environment:
      flutter: stable
      xcode: latest
      cocoapods: default
    scripts:
      - name: Initialize iOS with Permissions Fix
        script: |
          # 1. 刪除舊的 iOS 設定，確保乾淨重來
          rm -rf ios
          flutter create . --platforms ios

          # 2. 【核心修復】強制產生一個帶有「定位權限開關」的 Podfile
          # 這行 ENV['PERMISSION_LOCATION'] = '1' 就是讓按鈕復活的關鍵
          cat > ios/Podfile <<EOF
          platform :ios, '13.0'
          ENV['PERMISSION_LOCATION'] = '1'
          
          target 'Runner' do
            use_frameworks!
            use_modular_headers!
            flutter_install_all_ios_pods File.dirname(File.realpath(__FILE__))
          end
          
          post_install do |installer|
            installer.pods_project.targets.each do |target|
              flutter_additional_ios_build_settings(target)
            end
          end
          EOF

      - name: Build IPA and Pack
        script: |
          # 3. 編譯 App (這一步會讀取上面的 Podfile 設定)
          flutter build ipa --no-codesign --release

          # 4. 手動打包成 IPA (確保 Artifacts 抓得到)
          mkdir -p build/ios/ipa
          cd build/ios/archive/Runner.xcarchive/Products/Applications
          mkdir Payload
          cp -r Runner.app Payload/
          zip -r Runner.ipa Payload
          mv Runner.ipa ../../../../../ipa/
          
    artifacts:
      - build/ios/ipa/*.ipa