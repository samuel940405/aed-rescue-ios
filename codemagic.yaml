workflows:
  ios-release:
    name: iOS Release
    max_build_duration: 60
    instance_type: mac_mini_m2
    environment:
      flutter: stable
      xcode: latest
      cocoapods: default
    scripts:
      - name: Initialize iOS & Inject Permissions
        script: |
          # 1. 讓 Flutter 產生標準且正確的 iOS 專案結構
          rm -rf ios
          flutter create . --platforms ios

          # 2. 【外科手術】在自動產生的 Podfile 最頂端插入定位開關
          # 這樣既保留了 Flutter 的連線，又強行開啟了定位權限
          sed -i '' "1i\\
          ENV['PERMISSION_LOCATION'] = '1'\\
          " ios/Podfile

      - name: Build IPA and Pack
        script: |
          # 3. 執行編譯（這步會跑 pod install，這次絕對會過）
          flutter build ipa --no-codesign --release

          # 4. 標準打包流程
          mkdir -p build/ios/ipa
          cd build/ios/archive/Runner.xcarchive/Products/Applications
          mkdir Payload
          cp -r Runner.app Payload/
          zip -r Runner.ipa Payload
          mv Runner.ipa ../../../../../ipa/
          
    artifacts:
      - build/ios/ipa/*.ipa